<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AppEKG: AppEKG</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AppEKG
   &#160;<span id="projectnumber">1</span>
   </div>
   <div id="projectbrief">Heartbeat Instrumentation Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">AppEKG </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>AppEKG is a heartbeat instrumentation library and analysis framework, enabling the tracking and analysis of application performance at the application phase level with a low-overhead, production-usable method.</p>
<p>The defined macros are the preferred way of creating AppEKG instrumentation in an application, but the underlying functions are also available in the API; the functions for begin/end heartbeats do not inherently support a rate factor, however.</p>
<p>The macro interface is: <br  />
</p><ul>
<li><a class="el" href="appekg_8h.html#af07bd32a1af2d3b7c0be0d6b4eef9d46" title="Begin a heartbeat (insert this at beginning site of instrumentation)">EKG_BEGIN_HEARTBEAT(id, rateFactor)</a></li>
<li><a class="el" href="appekg_8h.html#a3be912c754e98df0a44eb2a45258925d" title="End a heartbeat (insert this at ending site of instrumentation)">EKG_END_HEARTBEAT(id)</a></li>
<li><a class="el" href="appekg_8h.html#a2c43f9d5eac7ae2c5a7359a8c7a2b37d" title="Create an impulse heartbeat (single site instrumentation)">EKG_PULSE_HEARTBEAT(id, rateFactor)</a></li>
<li><a class="el" href="appekg_8h.html#a14f12a06f0b76baedcd282f5bbe05814" title="Initialize AppEKG.">EKG_INITIALIZE(numHeartbeats, samplingInterval, appid, jobid, rank, silent)</a></li>
<li><a class="el" href="appekg_8h.html#ae2324b82851b0829cd82558dd86ce714" title="Shut down AppEKG and stop collecting heartbeat data.">EKG_FINALIZE()</a></li>
<li><a class="el" href="appekg_8h.html#a580dcec3ff047566cd50312a3f5266d5" title="Stop AppEKG from collecting heartbeat data, possibly temporarily.">EKG_DISABLE()</a></li>
<li><a class="el" href="appekg_8h.html#a46071c2e205549c0c14d2344b43c378e" title="Start (restart) AppEKG collecting heartbeat data.">EKG_ENABLE()</a></li>
<li><a class="el" href="appekg_8h.html#a196f03a8a55bcb37f0989ec8107858a2" title="Provide a name for a heartbeat.">EKG_NAME_HEARTBEAT(id, name)</a></li>
<li><a class="el" href="appekg_8h.html#ae413b012a62c821453522a9c47f8e6ca" title="Lookup heartbeat by name and return the ID.">EKG_IDOF_HEARTBEAT(name)</a></li>
<li><a class="el" href="appekg_8h.html#af7178a628e72f2b7161aca85aa366163" title="Lookup heartbeat by ID and return the name.">EKG_NAMEOF_HEARTBEAT(id)</a></li>
</ul>
<p>Heartbeat IDs are small integers starting at 1, and must be sequential. A unique heartbeat ID is meant to represent a particular phase or kernel of the application, and generally each instrumentation site has a unique heartbeat ID.</p>
<p><em>rateFactor</em> controls the speed of heartbeat production, if an instrumentation site is invoked too frequently. A rateFactor of 100, for example, would produce a heartbeat once every 100 executions of the instrumentation site.</p>
<p>AppEKG initialization accepts as parameters the number of unique heartbeats (maximum heartbeat ID), the number of seconds between data samples, a unique application ID, job ID, MPI rank, and a silent flag for turning off (unlikely but possible) stderr messages. If the job ID is left 0, PBS and Slurm environment variables are checked and used to set it. An application ID is useful when creating a historical database of multiple applications' data.</p>
<p>Heartbeats can be given a name using the API; names should generally refer to the conceptual meaning of the application phase or kernel the heartbeat is capturing.</p>
<p>Environment Variables: <br  />
</p><ul>
<li>APPEKG_SAMPLING_INTERVAL : integer, number of seconds between samples; will override AppEKG initialization parameter</li>
<li>APPEKG_OUTPUT_PATH : string to prepend to output file names; '/' is added at end and does not need to be included. If string contains one d, the application ID is inserted at that spot; if it contains two d's, the job ID is inserted for the second one. Other % options will cause the string to be used as is, without substitutions.</li>
<li>PBS_JOBID : if found, used for the 'jobid' data field, if param jobid=0</li>
<li>SLURM_JOB_ID : if found, used for the 'jobid' data field, if param jobid=0</li>
</ul>
<h1><a class="anchor" id="autotoc_md1"></a>
Building</h1>
<p><em>make</em> should work in the main directory; <em>make doc</em> will create doxygen documentation. If you need to select optional output modes such as LDMS streams, edit the Makefile to set it up properly.</p>
<p>In the <em>test</em> directory, <em>make</em> will build a variety of tests. The test <em>evensum</em> is the most complete, using OpenMP threads to generate heartbeats per thread. Run as 'OMP_NUM_THREADS=2 ./evensum' to ,e.g., set the number of threads to 2.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Running an application</h1>
<p>In the <em>test</em> directory, running the <em>evensum</em> executable will produce two output files one named 'appekg-###.json' and one named 'appekg-###.csv'. The number in the filename is the PID of the process (on a cluster, each process will produce its own heartbeat data files).</p>
<p>The JSON file is the metadata for the heartbeat data, and includes a variety of data fields; most are self-explanatory. The field <em>component</em> is a number that is extracted from the host name, if the name has a number in it (most HPC clusters set up their computational nodes with names with ID numbers in them).</p>
<p>The CSV files is the heartbeat data, in column format. The first two columns are a timestamp (end of sampling interval, milliseconds since the beginning of the execution) and a thread ID (a unique, small but non-consecutive integer value). The rest of the columns is heartbeat data, two columns per heartbeat; the first is the number of heartbeats that occurred in this sampling interval, the second is the average duration of these heartbeats (microseconds).</p>
<p>AppEKG does keep heartbeat data per thread, using hashing to quickly locate the thread data region; hash collisions can cause threads to be ignored, and the hash table is static in size and will not grow. The default size is 57 but can be changed by editing <em><a class="el" href="appekg_8h.html" title="External API Definition.">appekg.h</a></em> (around line 90).</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Running analyses</h1>
<p>There are different scripts in the <em>analyses</em> directory that you can run to conduct different analyses over the collected heartbeat data.</p>
<h2><a class="anchor" id="autotoc_md4"></a>
Requirements</h2>
<p>The analyses scripts depend on the following modules:</p><ul>
<li>pandas&gt;=1.5.0</li>
<li>numpy&gt;=1.23.3</li>
<li>matplotlib&gt;=3.6.0</li>
<li>argparse&gt;=1.4.0</li>
</ul>
<p><b>Note</b>: These are not necessarily hard requirements, other new but less recent versions will probably work; we have not done extensive version testing.</p>
<p>To install those requirements in your environment using <em>pip</em>, run: </p><div class="fragment"><div class="line">pip3 install -r requirements.txt</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md5"></a>
Running statistics on heartbeat data</h2>
<p>The <em>stats.py</em> prints out statistics per threadID per timemsec and processID per threadID in a CSV format. These statistics consist of min, max, std, mean, median, range, Q1, Q2, Q3, skew, kurtosis, count. It reads the CSV files that were produced by the AppEKG tool.</p>
<p><b>How to run the script?</b> </p><div class="fragment"><div class="line">python3 stats.py [options]</div>
</div><!-- fragment --><p><b>Options:</b></p><ul>
<li>&ndash;input or -i: required to specify heartbeat data path. Make sure the heartbeat data in the the directory is from a single run.</li>
<li>&ndash;type or -t: required to select what to data statistics to output.<ul>
<li>per-tid-timemsec - statistics calculated over all ranks per threadID per timemsec.</li>
<li>per-pid-tid - statistics calculated per rank per threadID.</li>
</ul>
</li>
</ul>
<p>Examples:</p><ol type="1">
<li>To print statistics based on heartbeat data located in "/path/toMyInput" per rank per threadID in "/path/toMyInput", run: <div class="fragment"><div class="line">python3 stats.py --input &quot;/path/toMyInput&quot; --type per-pid-tid</div>
</div><!-- fragment --></li>
<li>To save statistics based on heartbeat data located in "/path/toHBData/" over all ranks per threadID per timemsec and save the data in "/path/where/toSaveStats/stats.csv" <div class="fragment"><div class="line">python stats.py -i /path/toHBData/ -p per-tid-timemsec &gt; /path/where/toSaveStats/stats.csv</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md6"></a>
Plotting the counts and durations of all heartbeats</h2>
<p>The <em>plotting.py</em> script plots heartbeat counts and durations. It reads the CSV and JSON files that were produced by the AppEKG tool and then plots the heartbeat data. It plots heartbeat data per rank and per threadID per rank. Each created plot contains a plot of each heartbeat. the AppEKG tool produces a CSV file from each rank, where each file consists the heartbeat data of the related rank. If an application is multithreaded, different threads in each CSV will present, where each thread produces its own heartbeat data.</p><ol type="1">
<li>Per rank plotting: this plots the heartbeat data of the CSV files (ranks) regardless of the threadIDs. It skips the threadIDs and consider the heartbeat data of a single rank for plotting.</li>
<li>Per threadID per rank plotting: this plots the heartbeat data of each threadID. When the application is multithreaded, each CSV file contains the heartbeat data per threadID. If there are 4 threads, there will be 2 plots per threadID (one for heartbeat count and one for duration). This means threre will be 8 plots per CSV file (rank). <br  />
</li>
</ol>
<p><b>How to run the script?</b> </p><div class="fragment"><div class="line">python3 plotting.py [options]</div>
</div><!-- fragment --><p><b>Options:</b></p><ul>
<li>&ndash;input or -i: required to specify heartbeat data path. Make sure the heartbeat data in the the directory is from a single run.</li>
<li>&ndash;output or -o: optional to specify where to save the plots. If not defined, the input path is used.</li>
<li>&ndash;plot or -p: optional to select what to plot. If not defined all plot types are produced (per rank and per threadID per processID).<ul>
<li>per-rank: plot heartbeat data per-processID only. If the app were run on 4 processes, 8 plots are created. (4 heartbeat counts and 4 heartbeat durations).</li>
<li>per-tid-rank: plot heartbeat data per-threadID per-processID. If the app were run on 4 threads and 2 processes, 16 plots are created (8 heartbeat counts and 8 heartbeat durations), where each plot represents the data per-threadID per-processID.</li>
</ul>
</li>
<li>&ndash;tid or -t: optinal to plot data of specific threadIDs. If not defined, heartbeat data of all threadIDs will plot</li>
<li>&ndash;rank or -r: optional to plot data of specific ranks. If not defined, heartbeat data of all ranks will plot</li>
<li>&ndash;getranktid or -g: optional to print thread IDs and ranks. Default is set to false.</li>
<li>&ndash;show: optional to preview plots. Default is set to false.</li>
</ul>
<p>Examples:</p><ol type="1">
<li>To plot heartbeat data located in "/path/toMyInput" per rank and save plots in "/path/toMyInput", run: <div class="fragment"><div class="line">python3 plotting.py --input &quot;/path/toMyInput&quot; --plot per-rank</div>
</div><!-- fragment --></li>
<li>To plot heartbeat data located in "/path/toHBData/" per threadID per rank and save the plots in "/path/where/toSavePlots" <div class="fragment"><div class="line">python plotting.py -i /path/toHBData/ -o /path/where/toSavePlots -p per-tid-rank</div>
</div><!-- fragment --></li>
<li>To plot heartbeat data located in "/path/toMyInput" of rank 15 only per rank and save plots in the same path of input, run: <div class="fragment"><div class="line">python3 plotting.py --input &quot;/path/toMyInput&quot; --plot per-rank --rank 15</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md7"></a>
Plotting the counts and durations of all heartbeats per threadID/timemsec and field/timemsec</h2>
<p>The <em>plot_per_interval.py</em> script plots heartbeat counts and durations. It reads the CSV file file that was produced by the <em>stats.py</em> script when chosing an "per-tid-timemsec" option and then plots the average heartbeat data over all processes. It plots heartbeat data per threadID and timemsec, and per field and timemsec.</p>
<p><b>How to run the script?</b> </p><div class="fragment"><div class="line">python3 plot_per_interval.py [options]</div>
</div><!-- fragment --><p><b>Options:</b></p><ul>
<li>&ndash;input or -i: required to specify data path for output of the <em>stats.py</em> script when chosing an "per-tid-timemsec" option.</li>
<li>&ndash;output or -o: optional to specify where to save the plots. If not defined, the input path is used.</li>
<li>&ndash;plot or -p: optional to select what to plot. If not defined all plot types are produced (per threadID per timemsec and per field per timemsec).<ul>
<li>per-tid-timemsec: plot heartbeat data per-threadID per-timemsec only. If the app has 3 heartbeats, 6 plots are created. (3 heartbeat counts and 3 heartbeat durations).</li>
<li>per-field-timemsec: plot average heartbeat data for all processes per-field per-timemsec. If the app has 3 heartbeats, 6 plots are created. (3 heartbeat counts and 3 heartbeat durations).</li>
</ul>
</li>
<li>&ndash;show: optional to preview plots. Default is set to false.</li>
</ul>
<p>Examples:</p><ol type="1">
<li>To plot heartbeat data located in "/path/toMyInput" per threadID per timemsec and save plots in "/path/toMyInput", run: <div class="fragment"><div class="line">python3 plot_per_interval.py --input &quot;/path/toMyInput&quot; --plot per-tid-timemsec</div>
</div><!-- fragment --></li>
<li>To plot heartbeat data located in "/path/toHBData/" per field per timemsec and save the plots in "/path/where/toSavePlots" <div class="fragment"><div class="line">python plot_per_interval.py  -i /path/toHBData/ -o /path/where/toSavePlots -p per-field-timemsec</div>
</div><!-- fragment --></li>
</ol>
<h1><a class="anchor" id="autotoc_md8"></a>
Acknowledgments</h1>
<p>This work was supported in part by Sandia National Laboratories. No endorsement is implied. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Oct 8 2025 11:03:48 for AppEKG by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
